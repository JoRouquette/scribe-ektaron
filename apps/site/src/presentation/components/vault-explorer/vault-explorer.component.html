<nav class="explorer">
  <div class="search">
    <app-search-bar
      placeholder="Rechercher dossiers/fichiers/tags"
      [value]="q()"
      (queryChange)="onInputQuery($event)"
    ></app-search-bar>
  </div>

  <mat-divider class="sep"></mat-divider>

  <div class="tree-wrap" #treeScroller (scroll)="syncX('tree')">
    @if (noData()) {
      <div class="empty-state" aria-live="polite">
        <mat-icon aria-hidden="true">folder_off</mat-icon>
        <p class="title">Aucune donnée</p>
        <p class="hint">Le site ne contient pas encore de dossiers ou fichiers publiés.</p>
      </div>
    }

    @if (!noData() && noResult()) {
      <div class="empty-state" aria-live="polite">
        <mat-icon aria-hidden="true">search_off</mat-icon>
        <p class="title">Aucun résultat</p>
        <p class="hint">Aucun dossier, fichier ou tag ne correspond à cette recherche.</p>
      </div>
    }

    <mat-tree
      class="tree"
      [dataSource]="rootChildren()"
      [childrenAccessor]="childrenOf"
      [trackBy]="trackByPath"
    >
      <!-- Dossier -->
      <mat-nested-tree-node
        *matTreeNodeDef="let n; when: isFolder"
        #node="matNestedTreeNode"
        class="node folder"
        [attr.aria-expanded]="node.isExpanded || shouldAutoExpand(n)"
        matTreeNodePadding
        [matTreeNodePaddingIndent]="'0.4em'"
      >
        <button
          class="node-header"
          type="button"
          matTreeNodeToggle
          aria-label="Ouvrir/fermer le dossier"
          [routerLink]="['/' + n.path + '/index']"
        >
          <mat-icon class="ico folder-ico" aria-hidden="true">
            {{ node.isExpanded || shouldAutoExpand(n) ? 'folder_open' : 'folder' }}
          </mat-icon>
          <span class="label" [title]="n.label || n.name || 'root'">
            {{ n.label || n.name || 'root' }}
          </span>
        </button>

        <div
          class="children"
          [class.open]="node.isExpanded || shouldAutoExpand(n)"
          [attr.aria-hidden]="!(node.isExpanded || shouldAutoExpand(n))"
        >
          <div class="children-inner">
            <ng-container matTreeNodeOutlet></ng-container>
          </div>
        </div>
      </mat-nested-tree-node>

      <!-- Fichier -->
      <mat-tree-node
        *matTreeNodeDef="let n; when: isFile"
        class="node file"
        matTreeNodePadding
        [matTreeNodePaddingIndent]="'0.4em'"
        matTooltip="Ouvrir le fichier"
      >
        <a
          class="file-link"
          [routerLink]="['/' + n.path]"
          [title]="n.label"
          aria-label="Ouvrir le fichier"
        >
          <mat-icon class="ico file-ico" aria-hidden="true">description</mat-icon>
          <span class="label">{{ n.label }}</span>
        </a>
      </mat-tree-node>
    </mat-tree>
  </div>

  <div class="hscroll" #hScroller (scroll)="syncX('h')">
    <div class="phantom" [style.width.px]="treeScrollWidth"></div>
  </div>
</nav>
