name: Workspace CI, Release and Publishing

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  NODE_VERSION: '22.14.0'
  REGISTRY_URL: ${{ vars.REGISTRY_URL }}
  IMAGE_NAME: ${{ vars.IMAGE_NAME }}

concurrency:
  group: pipeline-${{ github.ref }}
  cancel-in-progress: true

jobs:
  quality:
    name: Lint, test and build workspace
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm

      - name: Install dependencies
        run: npm install --no-audit --no-fund --ignore-scripts
        env:
          HUSKY: 0

      - name: Lint (Nx)
        run: npm run lint

      - name: Test (Nx)
        run: npm run test

      - name: Build (Nx)
        run: npm run build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist
          if-no-files-found: error
          retention-days: 1

  semantic-release:
    name: Semantic release
    needs: quality
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm

      - name: Install dependencies
        run: npm install --no-audit --no-fund --ignore-scripts
        env:
          HUSKY: 0

      - name: Run semantic-release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: npx semantic-release

  obsidian-plugin-dry-run:
    name: Package & dry-run publish Obsidian plugin
    needs: semantic-release
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout latest release commit
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Sync to latest branch state
        run: |
          git fetch origin "${GITHUB_REF_NAME}"
          git checkout "origin/${GITHUB_REF_NAME}"

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm

      - name: Install dependencies
        run: npm install --no-audit --no-fund --ignore-scripts
        env:
          HUSKY: 0

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: .

      - name: Ensure plugin build exists
        run: |
          if [ ! -f "dist/apps/publish-to-personal-vps/main.js" ]; then
            echo "dist artifact missing plugin build; rebuilding plugin only"
            npx nx run publish-to-personal-vps:build --skip-nx-cache
          fi

      - name: Package plugin for Obsidian publishing
        run: node apps/publish-to-personal-vps/scripts/package-plugin.mjs

      - name: Semantic-release dry-run
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: npx semantic-release --config apps/publish-to-personal-vps/.releaserc.json --dry-run

  docker-images:
    name: Build and publish Docker images
    needs: semantic-release
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout latest release commit
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Sync to latest branch state
        run: |
          git fetch origin "${GITHUB_REF_NAME}"
          git checkout "origin/${GITHUB_REF_NAME}"
          git fetch --tags --force

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm

      - name: Compute image tags
        id: vars
        run: |
          VERSION=$(git describe --tags --abbrev=0 || node -p "require('./package.json').version")
          echo "version=${VERSION#v}" >> "$GITHUB_OUTPUT"
          echo "short_sha=${GITHUB_SHA::7}" >> "$GITHUB_OUTPUT"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to private registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY_URL }}
          username: ${{ secrets.REGISTRY_USER }}
          password: ${{ secrets.REGISTRY_PASSWORD }}

      - name: Log in to Docker Hub (for dry-run build cache)
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push to private registry
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: |
            ${{ env.REGISTRY_URL }}/${{ env.IMAGE_NAME }}:${{ steps.vars.outputs.version }}
            ${{ env.REGISTRY_URL }}/${{ env.IMAGE_NAME }}:${{ steps.vars.outputs.short_sha }}
            ${{ env.REGISTRY_URL }}/${{ env.IMAGE_NAME }}:latest
          cache-from: type=registry,ref=${{ env.REGISTRY_URL }}/${{ env.IMAGE_NAME }}:buildcache
          cache-to: type=registry,ref=${{ env.REGISTRY_URL }}/${{ env.IMAGE_NAME }}:buildcache,mode=max

      - name: Build for Docker Hub (dry-run, no push)
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          push: false
          tags: |
            docker.io/${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:${{ steps.vars.outputs.version }}
            docker.io/${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:${{ steps.vars.outputs.short_sha }}
            docker.io/${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:latest
          cache-from: type=registry,ref=${{ env.REGISTRY_URL }}/${{ env.IMAGE_NAME }}:buildcache
